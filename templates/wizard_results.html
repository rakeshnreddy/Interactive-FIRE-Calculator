{% extends "base.html" %}

{% block title %}{{ title }} - {{ super() }}{% endblock %}

{% block content %}
  <h2>{{ title }}</h2>

  {# Display general error message if any from calculation #}
  {% if error_message %}
    <div class="alert alert-danger" role="alert">
      <h4>{{_("Calculation Error")}}</h4>
      <p>{{ error_message }}</p>
    </div>
  {% endif %}

  {# Prominent Results Section #}
  {% if P_calculated_display and P_calculated_display != "Error" and P_calculated_display != "Not Feasible" %}
  <div class="card text-center mb-4">
    <div class="card-header">
      {{_("Key Results")}}
    </div>
    <div class="card-body">
      <h3 class="card-title">{{_("Your Calculated FIRE Number:")}}</h3>
      <p class="display-4 fw-bold text-success">{{ P_calculated_display }}</p>
      <hr>
      <h5 class="card-title mt-3">{{_("Based on:")}}</h5>
      <p class="card-text fs-5">
        {{_("Input Annual Expenses (W):")}} <strong>{{ W_display }}</strong>
      </p>
    </div>
  </div>
  {% elif P_calculated_display %}
    {# Case where calculation resulted in "Error" or "Not Feasible" but no flash error_message #}
    <div class="alert alert-warning text-center mb-4" role="alert">
        <h4 class="alert-heading">{{_("Calculation Outcome")}}</h4>
        <p class="fs-5">{{_("Calculated Required Initial Portfolio (FIRE Number):")}} <strong>{{ P_calculated_display }}</strong></p>
        <hr>
        <p class="mb-0">{{_("Based on Input Annual Expenses (W):")}} <strong>{{ W_display | default(W) }}</strong></p>
    </div>
  {% endif %}


  {# Detailed Summary of Inputs Used #}
  <div class="card mb-4">
    <div class="card-header">
      {{_("Summary of Inputs Used for Calculation")}}
    </div>
    <ul class="list-group list-group-flush">
      <li class="list-group-item">{{_("Overall Nominal Return Rate:")}} {{ (r_overall_nominal * 100) | round(2) }}%</li>
      <li class="list-group-item">{{_("Overall Inflation Rate:")}} {{ (i_overall * 100) | round(2) }}%</li>
      <li class="list-group-item">{{_("Total Duration (from periods):")}} {{ total_duration_from_periods }} {{_("years")}}</li>
      <li class="list-group-item">{{_("Withdrawal Timing:")}} {{ withdrawal_time_str | capitalize }}</li>
      <li class="list-group-item">{{_("Desired Final Portfolio Value:")}} {{ desired_final_value }}</li>
    </ul>
  </div>

  {# Rates Periods Used (if any) #}
  {% if rates_periods_summary %}
    <div class="card mb-4">
      <div class="card-header">{{_("Rates Periods Used:")}}</div>
      <ul class="list-group list-group-flush">
      {% for p in rates_periods_summary %}
        <li class="list-group-item">{{_("Duration:")}} {{ p.duration }} {{_("years")}}, {{_("Nominal Rate:")}} {{ (p.r * 100) | round(2) }}%, {{_("Inflation:")}} {{ (p.i * 100) | round(2) }}%</li>
      {% endfor %}
      </ul>
    </div>
  {% endif %}

  {# One-Off Events Considered (if any) #}
  {% if one_off_events_summary %}
    <div class="card mb-4">
      <div class="card-header">{{_("One-Off Events Considered:")}}</div>
      <ul class="list-group list-group-flush">
      {% for e in one_off_events_summary %}
        <li class="list-group-item">{{_("Year:")}} {{ e.year }}, {{_("Amount:")}} {{ e.amount }}</li>
      {% endfor %}
      </ul>
    </div>
  {% else %}
    <div class="card mb-4">
        <div class="card-header">{{_("One-Off Events Considered:")}}</div>
        <div class="card-body"><p>{{_("No one-off events.")}}</p></div>
    </div>
  {% endif %}

  {# Plots #}
  {% if P_calculated_display and P_calculated_display != "Error" and P_calculated_display != "Not Feasible" %}
    <div class="row">
      <div class="col-md-12 mb-3">
        {{ plot1_div | safe }}
      </div>
      <div class="col-md-12">
        {{ plot2_div | safe }}
      </div>
    </div>
  {% endif %}

  {# Year-by-Year Simulation Table #}
  {% if table_rows and P_calculated_display != "Error" and P_calculated_display != "Not Feasible" %}
    <h4 class="mt-4">{{_("Year-by-Year Simulation:")}}</h4>
    <div class="mt-3 table-responsive">
      <table class="table table-striped table-hover">
        <thead>
          <tr>
            <th>{{_("Year")}}</th>
            <th>{{_("End of Year Portfolio Balance")}}</th>
            <th>{{_("Annual Withdrawal")}}</th>
          </tr>
        </thead>
        <tbody>
          {% for row in table_rows %}
          <tr>
            <td>{{ row.year }}</td>
            <td>{{ row.balance }}</td>
            <td>{{ row.withdrawal }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  {% elif not error_message and P_calculated_display != "Error" and P_calculated_display != "Not Feasible" %}
    <h4 class="mt-4">{{_("Year-by-Year Simulation:")}}</h4>
    <p>{{_("Simulation data not available.")}}</p>
  {% endif %}

  <div class="mt-4 text-center">
    <a href="{{ url_for('wizard_bp.wizard_expenses_step') }}" class="btn btn-secondary">{{ _("Start New Wizard") }}</a>
    <a href="{{ url_for('project.index') }}" class="btn btn-info">{{ _("Back to Home") }}</a>
  </div>

{% endblock %}
