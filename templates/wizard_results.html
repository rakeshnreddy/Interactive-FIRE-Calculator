{% extends "base.html" %}

{% block title %}{{ title }} - {{ super() }}{% endblock %}

{% block head_extra %}
    <meta name="csrf-token" content="{{ csrf_token_for_ajax }}"> {# For JS to fetch for AJAX headers #}
{% endblock %}

{% block content %}
  <h2>{{ title }}</h2>

  {# Display general error message if any from initial calculation #}
  {% if error_message %}
    <div class="alert alert-danger" role="alert">
      <h4>{{_("Initial Calculation Error")}}</h4>
      <p>{{ error_message }}</p>
    </div>
  {% endif %}

  {# --- Main Key Results & Consolidated Fixed Inputs --- #}
  <div class="card text-center mb-4">
    <div class="card-header">
      {{_("Calculation Summary")}}
    </div>
    <div class="card-body">
      {# Prominent Main Result #}
      {% if P_calculated_display and P_calculated_display != "Error" and P_calculated_display != "Not Feasible" %}
        <h3 class="card-title">{{_("Your Calculated FIRE Number:")}}</h3>
        <p class="display-4 fw-bold text-success">{{ P_calculated_display }}</p>
        <hr>
        <h5 class="card-title mt-3">{{_("Based on:")}}</h5>
        <p class="card-text fs-5 mb-1">
          {{_("Input Annual Expenses (W):")}} <strong>{{ W_display }}</strong>
        </p>
      {% elif P_calculated_display %}
        <div class="alert alert-warning" role="alert"> {# Changed to alert instead of separate card for error case display #}
            <h4 class="alert-heading">{{_("Calculation Outcome")}}</h4>
            <p class="fs-5">{{_("Calculated Required Initial Portfolio (FIRE Number):")}} <strong>{{ P_calculated_display }}</strong></p>
            <hr>
            <p class="mb-0">{{_("Based on Input Annual Expenses (W):")}} <strong>{{ W_display | default(W) }}</strong></p>
        </div>
      {% endif %}

      {# Consolidated Fixed Inputs - made more concise #}
      <div class="mt-3 text-muted small">
        <p class="mb-1">
          {{_("Overall Nominal Return:")}} {{ (r_overall_nominal * 100) | round(2) }}% |
          {{_("Inflation:")}} {{ (i_overall * 100) | round(2) }}% |
          {{_("Duration:")}} {{ total_duration_from_periods }} {{_("yrs")}}
        </p>
        <p class="mb-1">
          {{_("Withdrawal Timing:")}} {{ withdrawal_time_str | capitalize }} |
          {{_("Desired Final Portfolio:")}} {{ desired_final_value | default(0.0) }}
        </p>
        {% if rates_periods_summary and (rates_periods_summary | length > 1 or (rates_periods_summary | length == 1 and (rates_periods_summary[0].r != r_overall_nominal or rates_periods_summary[0].i != i_overall))) %}
          <p class="mb-1"><em>{{_("Custom rate periods applied for specific durations.")}}</em></p>
        {% endif %}
        {% if one_off_events_summary %}
          <p class="mb-0"><em>{{_("One-off financial events considered.")}}</em></p>
        {% else %}
          <p class="mb-0"><em>{{_("No one-off events specified.")}}</em></p>
        {% endif %}
      </div>
    </div>
  </div>{# End of Main Key Results & Consolidated Fixed Inputs Card #}

  {# --- Interactive What-If Analysis (Moved Here) --- #}
  <div class="card text-center mb-4">
    <div class="card-header">
      {{_("Interactive What-If Analysis")}}
    </div>
    <div class="card-body">
      <div class="row g-3 align-items-center justify-content-center">
        <div class="col-auto">
          <label for="interactive_w" class="col-form-label">{{_("Adjust Annual Expenses (W):")}}</label>
        </div>
        <div class="col-auto">
          <input type="number" id="interactive_w" class="form-control" value="{{ W | default(0.0) }}" step="1000">
        </div>
        <div class="col-auto p-3">
            <i class="fas fa-exchange-alt fa-2x"></i> {# Placeholder for arrows or visual cue - FontAwesome needed #}
        </div>
        <div class="col-auto">
          <label for="interactive_p" class="col-form-label">{{_("Adjust Target Portfolio (P):")}}</label>
        </div>
        <div class="col-auto">
          <input type="number" id="interactive_p" class="form-control" value="{{ P_raw | default(0.0) }}" step="10000">
        </div>
      </div>
       <small class="form-text text-muted mt-2">{{_("Change one value to see how it impacts the other. Other parameters (rates, duration) remain fixed as per your wizard inputs.")}}</small>
    </div>
  </div> {# End of Interactive Analysis Card #}

  {# Prominent Results Display for Interactive changes (dynamic) - This div is distinct from the initial result display #}
  {# The initial display is now part of the "Calculation Summary" card when P_calculated_display is valid #}
  {# This #dynamic-results-display div is for JS to update the main P and W numbers if needed, or can be removed if inputs directly reflect the state #}
  {# Based on current JS, only input fields and plots are updated. So, the static display in "Calculation Summary" remains the reference from initial calculation. #}
  {# The prompt asked for a section with id="dynamic-results-display" to be populated by JS. #}
  {# Let's make it clearer: the initial display is in the summary card. JS updates interactive inputs and plots. #}
  {# The div below can be a target for JS to write *newly calculated* P and W if we want them displayed outside inputs. #}
  {# For now, current JS updates input fields and plots, not separate static text. #}
  {# The original plan had a display section: #}
  <!--
  <div id="dynamic-results-display" class="text-center mb-4">
    <h3 class="card-title">{{_("Calculated FIRE Number:")}}</h3>
    <p id="display_p" class="display-4 fw-bold text-success">{{ P_calculated_display }}</p>
    <hr>
    <h5 class="card-title mt-3">{{_("Sustainable Annual Expenses:")}}</h5>
    <p id="display_w" class="fs-5 card-text"><strong>{{ W_display }}</strong></p>
  </div>
  -->
  {# This section was part of the previous HTML structure. The current JS updates interactive_w/p fields and plots. #}
  {# If a separate static display is still desired for interactive updates, JS needs to target it. #}
  {# For now, I'm removing this duplicate static display as the interactive fields themselves show the current values. #}
  {# The "Key Results" section already displays the initial calculation. #}


  {# --- Plots (Now After Interactive Card) --- #}
  {% if P_calculated_display and P_calculated_display != "Error" and P_calculated_display != "Not Feasible" %}
    <div class="row">
      <div id="plot1_container" class="col-md-12 mb-3">
        {{ plot1_div | safe }}
      </div>
      <div id="plot2_container" class="col-md-12">
        {{ plot2_div | safe }}
      </div>
    </div>
  {% endif %}

  {# Hidden fields/script tags for fixed parameters (can remain at top or bottom of content block) #}
  <input type="hidden" id="initial_r_overall_nominal" value="{{ r_overall_nominal | default(0.0) }}">
  <input type="hidden" id="initial_i_overall" value="{{ i_overall | default(0.0) }}">
  <input type="hidden" id="initial_total_duration_from_periods" value="{{ total_duration_from_periods | default(30) }}">
  <input type="hidden" id="initial_withdrawal_time_str" value="{{ withdrawal_time_str | default('end') }}">
  <input type="hidden" id="initial_desired_final_value" value="{{ desired_final_value | default(0.0) }}">
  <script id="initial-rates-periods-data" type="application/json">{{ rates_periods_summary | default([]) | tojson | safe }}</script>
  <script id="initial-one-off-events-data" type="application/json">{{ one_off_events_summary | default([]) | tojson | safe }}</script>

  <div class="mt-4 text-center">
    <a href="{{ url_for('wizard_bp.wizard_expenses_step') }}" class="btn btn-secondary">{{ _("Start New Wizard") }}</a>
    <a href="{{ url_for('project.index') }}" class="btn btn-info">{{ _("Back to Home") }}</a>
  </div>

{% endblock %}

{% block scripts_extra %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const interactiveWField = document.getElementById('interactive_w');
    const interactivePField = document.getElementById('interactive_p');
    // const displayPElement = document.getElementById('display_p'); // Not updated by this JS
    // const displayWElement = document.getElementById('display_w'); // Not updated by this JS

    const plot1Container = document.getElementById('plot1_container');
    const plot2Container = document.getElementById('plot2_container');

    const initialROverallNominal = parseFloat(document.getElementById('initial_r_overall_nominal').value);
    const initialIOverall = parseFloat(document.getElementById('initial_i_overall').value);
    const initialTotalDuration = parseInt(document.getElementById('initial_total_duration_from_periods').value);
    const initialWithdrawalTimeStr = document.getElementById('initial_withdrawal_time_str').value;
    const initialDesiredFinalValue = parseFloat(document.getElementById('initial_desired_final_value').value);

    let initialRatesPeriods = [];
    try {
        const initialRatesPeriodsElem = document.getElementById('initial-rates-periods-data');
        if (initialRatesPeriodsElem && initialRatesPeriodsElem.textContent) {
            initialRatesPeriods = JSON.parse(initialRatesPeriodsElem.textContent);
        }
    } catch (e) {
        console.error("Error parsing initial rates periods data:", e);
    }

    let initialOneOffEvents = [];
    try {
        const initialOneOffEventsElem = document.getElementById('initial-one-off-events-data');
        if (initialOneOffEventsElem && initialOneOffEventsElem.textContent) {
            initialOneOffEvents = JSON.parse(initialOneOffEventsElem.textContent);
        }
    } catch (e) {
        console.error("Error parsing initial one-off events data:", e);
    }

    const csrfTokenMeta = document.querySelector('meta[name="csrf-token"]');
    const csrfToken = csrfTokenMeta ? csrfTokenMeta.getAttribute('content') : null;
    if (!csrfToken) {
        console.error('CSRF token not found!');
    }


    let debounceTimer;

    function handleInputChange(event) {
        clearTimeout(debounceTimer);
        debounceTimer = setTimeout(() => {
            const changedInputId = event.target.id;
            let changed_input_type = '';
            if (changedInputId === 'interactive_w') {
                changed_input_type = 'W';
            } else if (changedInputId === 'interactive_p') {
                changed_input_type = 'P';
            } else {
                return;
            }

            const wValue = parseFloat(interactiveWField.value) || 0;
            const pValue = parseFloat(interactivePField.value) || 0;

            const payload = {
                changed_input: changed_input_type,
                W_value: wValue,
                P_value: pValue,
                r_overall_nominal: initialROverallNominal,
                i_overall: initialIOverall,
                total_duration_from_periods: initialTotalDuration,
                withdrawal_time_str: initialWithdrawalTimeStr,
                fixed_desired_final_value: initialDesiredFinalValue,
                rates_periods_summary: initialRatesPeriods,
                one_off_events_summary: initialOneOffEvents
            };

            fetch("{{ url_for('wizard_bp.wizard_recalculate_interactive') }}", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                },
                body: JSON.stringify(payload)
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert("Recalculation Error: " + data.error);
                    if (changed_input_type === 'W' && data.new_P !== undefined) interactivePField.value = data.new_P.toFixed(0); else if (changed_input_type === 'W') interactivePField.value = pValue.toFixed(0);
                    if (changed_input_type === 'P' && data.new_W !== undefined) interactiveWField.value = data.new_W.toFixed(0); else if (changed_input_type === 'P') interactiveWField.value = wValue.toFixed(0);
                } else {
                    if (changed_input_type === 'W') {
                        interactivePField.value = data.new_P !== undefined ? data.new_P.toFixed(0) : '';
                    } else if (changed_input_type === 'P') {
                        interactiveWField.value = data.new_W !== undefined ? data.new_W.toFixed(0) : '';
                    }

                    if (plot1Container && data.plot1_div_html) {
                        plot1Container.innerHTML = data.plot1_div_html;
                    }
                    if (plot2Container && data.plot2_div_html) {
                        plot2Container.innerHTML = data.plot2_div_html;
                    }
                }
            })
            .catch(error => {
                console.error('Error during interactive recalculation:', error);
                alert('An error occurred while recalculating. Please check the console.');
            });
        }, 750);
    }

    if (interactiveWField) interactiveWField.addEventListener('input', handleInputChange);
    if (interactivePField) interactivePField.addEventListener('input', handleInputChange);

    // Initial console log for debugging data availability
    // console.log("Fixed params for JS:", {initialROverallNominal, initialIOverall, initialTotalDuration, initialWithdrawalTimeStr, initialDesiredFinalValue, initialRatesPeriods, initialOneOffEvents, csrfToken});
});
</script>
{% endblock %}
