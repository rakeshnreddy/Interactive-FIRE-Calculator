{% extends "base.html" %}

{% block title %}{{ title }} - {{ super() }}{% endblock %}

{% block head_extra %}
    <meta name="csrf-token" content="{{ csrf_token_for_ajax }}"> {# For JS to fetch for AJAX headers #}
{% endblock %}

{% block content %}
  <h2>{{ title }}</h2>

  {# Display general error message if any from initial calculation #}
  {% if error_message %}
    <div class="alert alert-danger" role="alert">
      <h4>{{_("Initial Calculation Error")}}</h4>
      <p>{{ error_message }}</p>
    </div>
  {% endif %}

  {# --- Main Key Results & Consolidated Fixed Inputs --- #}
  <div class="card text-center mb-4">
    <div class="card-header">
      {{_("Calculation Summary")}}
    </div>
    <div class="card-body">
      {% if P_calculated_display and P_calculated_display != "Error" and P_calculated_display != "Not Feasible" %}
        <h3 class="card-title">{{_("Your Calculated FIRE Number:")}}</h3>
        <p id="display_p" class="display-4 fw-bold text-success">{{ P_calculated_display }}</p> {# Static Original P #}
        <hr>
        <h5 class="card-title mt-3">{{_("Based on:")}}</h5>
        <p id="display_w" class="card-text fs-5 mb-1"> {# Static Original W #}
          {{_("Input Annual Expenses (W):")}} <strong>{{ W_display }}</strong>
        </p>
      {% elif P_calculated_display %}
        <div class="alert alert-warning" role="alert">
            <h4 class="alert-heading">{{_("Calculation Outcome")}}</h4>
            <p class="fs-5">{{_("Calculated Required Initial Portfolio (FIRE Number):")}} <strong id="display_p">{{ P_calculated_display }}</strong></p>
            <hr>
            <p class="mb-0">{{_("Based on Input Annual Expenses (W):")}} <strong id="display_w">{{ W_display | default(W) }}</strong></p>
        </div>
      {% endif %}
      <div class="mt-3 text-muted small">
        <p class="mb-1">
          {{_("Overall Nominal Return:")}} {{ (r_overall_nominal * 100) | round(2) }}% |
          {{_("Inflation:")}} {{ (i_overall * 100) | round(2) }}% |
          {{_("Duration:")}} {{ total_duration_from_periods }} {{_("yrs")}}
        </p>
        <p class="mb-1">
          {{_("Withdrawal Timing:")}} {{ withdrawal_time_str | capitalize }} |
          {{_("Desired Final Portfolio:")}} {{ desired_final_value | default(0.0) }}
        </p>
        {% if rates_periods_summary and (rates_periods_summary | length > 1 or (rates_periods_summary | length == 1 and (rates_periods_summary[0].r != r_overall_nominal or rates_periods_summary[0].i != i_overall))) %}
          <p class="mb-1"><em>{{_("Custom rate periods applied for specific durations.")}}</em></p>
        {% endif %}
        {% if one_off_events_summary %}
          <p class="mb-0"><em>{{_("One-off financial events considered.")}}</em></p>
        {% else %}
          <p class="mb-0"><em>{{_("No one-off events specified.")}}</em></p>
        {% endif %}
      </div>
    </div>
  </div>

  {# --- Static Original Calculation Plots (Side-by-Side) --- #}
  <h3 class="mt-4 mb-3 text-center">{{_("Original Calculation Plots")}}</h3>
  {% if P_calculated_display and P_calculated_display != "Error" and P_calculated_display != "Not Feasible" %}
    <div class="row">
      <div id="original_plot1_container" class="col-md-6 mb-3">
        {{ plot1_div | safe }} {# This is the original plot1_div from wizard_calculate_step #}
      </div>
      <div id="original_plot2_container" class="col-md-6 mb-3">
        {{ plot2_div | safe }} {# This is the original plot2_div from wizard_calculate_step #}
      </div>
    </div>
  {% else %}
    <p class="text-center">{{_("Original plots not available due to calculation error or infeasible scenario.")}}</p>
  {% endif %}

  {# --- Interactive What-If Analysis (Card with Sliders and its own Plots) --- #}
  <div class="card text-center mb-4 mt-5">
    <div class="card-header">
      {{_("Interactive What-If Analysis")}}
    </div>
    <div class="card-body">
      {# Row for W input and slider #}
      <div class="row g-3 align-items-center justify-content-center mb-3">
        <div class="col-md-3 text-md-end">
          <label for="interactive_w" class="col-form-label">{{_("Adjust Annual Expenses (W):")}}</label>
        </div>
        <div class="col-md-3">
          <input type="number" id="interactive_w" class="form-control interactive-input" data-changed="W" value="{{ W | default(0.0) }}" step="1000" min="0">
        </div>
        <div class="col-md-6">
          <input type="range" id="slider_w" class="form-range interactive-slider" data-target="interactive_w" value="{{ W | default(0.0) }}" min="0" max="{{ (W * 2) | default(100000) | int }}" step="1000">
        </div>
      </div>

      {# Row for P input and slider #}
      <div class="row g-3 align-items-center justify-content-center mb-3">
        <div class="col-md-3 text-md-end">
          <label for="interactive_p" class="col-form-label">{{_("Adjust Target Portfolio (P):")}}</label>
        </div>
        <div class="col-md-3">
          <input type="number" id="interactive_p" class="form-control interactive-input" data-changed="P" value="{{ P_raw | default(0.0) }}" step="10000" min="0">
        </div>
        <div class="col-md-6">
          <input type="range" id="slider_p" class="form-range interactive-slider" data-target="interactive_p" value="{{ P_raw | default(0.0) }}" min="0" max="{{ (P_raw * 2) | default(2000000) | int }}" step="10000">
        </div>
      </div>
      <small class="form-text text-muted mt-2">{{_("Change one value or use slider to see how it impacts the other. Plots below will update.")}}</small>

      {# New Plot Containers for Interactive Analysis (Side-by-Side) #}
      <div class="row mt-4">
        <div id="interactive_plot1_container" class="col-md-6 mb-3">
          <p>{{_("Interactive plots will appear here after adjustment.")}}</p>
        </div>
        <div id="interactive_plot2_container" class="col-md-6 mb-3">
          {# This will be populated by JS. #}
        </div>
      </div>
    </div>
  </div>

  {# Hidden fields/script tags for fixed parameters #}
  <input type="hidden" id="initial_r_overall_nominal" value="{{ r_overall_nominal | default(0.0) }}">
  <input type="hidden" id="initial_i_overall" value="{{ i_overall | default(0.0) }}">
  <input type="hidden" id="initial_total_duration_from_periods" value="{{ total_duration_from_periods | default(30) }}">
  <input type="hidden" id="initial_withdrawal_time_str" value="{{ withdrawal_time_str | default('end') }}">
  <input type="hidden" id="initial_desired_final_value" value="{{ desired_final_value | default(0.0) }}">
  <script id="initial-rates-periods-data" type="application/json">{{ rates_periods_summary | default([]) | tojson | safe }}</script>
  <script id="initial-one-off-events-data" type="application/json">{{ one_off_events_summary | default([]) | tojson | safe }}</script>

  <div class="mt-4 text-center">
    <a href="{{ url_for('wizard_bp.wizard_expenses_step') }}" class="btn btn-secondary">{{ _("Start New Wizard") }}</a>
    <a href="{{ url_for('project.index') }}" class="btn btn-info">{{ _("Back to Home") }}</a>
  </div>

{% endblock %}

{% block scripts_extra %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const interactiveWField = document.getElementById('interactive_w');
    const interactivePField = document.getElementById('interactive_p');

    const plot1Container = document.getElementById('interactive_plot1_container'); // Target new interactive plot container
    const plot2Container = document.getElementById('interactive_plot2_container'); // Target new interactive plot container

    const initialROverallNominal = parseFloat(document.getElementById('initial_r_overall_nominal').value);
    const initialIOverall = parseFloat(document.getElementById('initial_i_overall').value);
    const initialTotalDuration = parseInt(document.getElementById('initial_total_duration_from_periods').value);
    const initialWithdrawalTimeStr = document.getElementById('initial_withdrawal_time_str').value;
    const initialDesiredFinalValue = parseFloat(document.getElementById('initial_desired_final_value').value);

    let initialRatesPeriods = [];
    try {
        const initialRatesPeriodsElem = document.getElementById('initial-rates-periods-data');
        if (initialRatesPeriodsElem && initialRatesPeriodsElem.textContent) {
            initialRatesPeriods = JSON.parse(initialRatesPeriodsElem.textContent);
        }
    } catch (e) {
        console.error("Error parsing initial rates periods data:", e);
    }

    let initialOneOffEvents = [];
    try {
        const initialOneOffEventsElem = document.getElementById('initial-one-off-events-data');
        if (initialOneOffEventsElem && initialOneOffEventsElem.textContent) {
            initialOneOffEvents = JSON.parse(initialOneOffEventsElem.textContent);
        }
    } catch (e) {
        console.error("Error parsing initial one-off events data:", e);
    }

    const csrfTokenMeta = document.querySelector('meta[name="csrf-token"]');
    const csrfToken = csrfTokenMeta ? csrfTokenMeta.getAttribute('content') : null;
    if (!csrfToken) {
        console.error('CSRF token not found!');
    }

    let debounceTimer;

    function handleInputChange(event) {
        clearTimeout(debounceTimer);
        debounceTimer = setTimeout(() => {
            const changedElement = event.target;
            const changed_input_type = changedElement.dataset.changed; // 'W' or 'P' from number input, or undefined for slider

            if (!changed_input_type && !changedElement.classList.contains('interactive-slider')) return;

            let wValue = parseFloat(interactiveWField.value) || 0;
            let pValue = parseFloat(interactivePField.value) || 0;
            let final_changed_type = changed_input_type;

            if (changedElement.classList.contains('interactive-slider')) {
                const targetInputId = changedElement.dataset.target;
                const targetInput = document.getElementById(targetInputId);
                if (targetInput) {
                    targetInput.value = changedElement.value; // Sync slider to text input
                    if (targetInputId === 'interactive_w') {
                        wValue = parseFloat(targetInput.value) || 0;
                        final_changed_type = 'W';
                    } else if (targetInputId === 'interactive_p') {
                        pValue = parseFloat(targetInput.value) || 0;
                        final_changed_type = 'P';
                    }
                }
            } else if (changedElement.classList.contains('interactive-input')) {
                // Sync text input to slider
                const sliderId = "slider_" + changed_input_type.toLowerCase();
                const slider = document.getElementById(sliderId);
                if (slider) {
                    slider.value = changedElement.value;
                }
                final_changed_type = changed_input_type;
            }

            if (!final_changed_type) return;


            const payload = {
                changed_input: final_changed_type,
                W_value: wValue,
                P_value: pValue,
                r_overall_nominal: initialROverallNominal,
                i_overall: initialIOverall,
                total_duration_from_periods: initialTotalDuration,
                withdrawal_time_str: initialWithdrawalTimeStr,
                fixed_desired_final_value: initialDesiredFinalValue,
                rates_periods_summary: initialRatesPeriods,
                one_off_events_summary: initialOneOffEvents
            };

            fetch("{{ url_for('wizard_bp.wizard_recalculate_interactive') }}", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                },
                body: JSON.stringify(payload)
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert("Recalculation Error: " + data.error);
                    // Reset the field that was just changed by user, or the one that was supposed to be calculated
                    if (final_changed_type === 'W') { // W was changed, P was expected
                        interactivePField.value = data.new_P !== undefined ? parseFloat(data.new_P).toFixed(0) : pValue.toFixed(0);
                        if(document.getElementById('slider_p')) document.getElementById('slider_p').value = interactivePField.value;
                    } else if (final_changed_type === 'P') { // P was changed, W was expected
                        interactiveWField.value = data.new_W !== undefined ? parseFloat(data.new_W).toFixed(0) : wValue.toFixed(0);
                        if(document.getElementById('slider_w')) document.getElementById('slider_w').value = interactiveWField.value;
                    }
                } else {
                    if (final_changed_type === 'W') {
                        interactivePField.value = data.new_P !== undefined ? parseFloat(data.new_P).toFixed(0) : '';
                        if(document.getElementById('slider_p')) document.getElementById('slider_p').value = interactivePField.value;
                    } else if (final_changed_type === 'P') {
                        interactiveWField.value = data.new_W !== undefined ? parseFloat(data.new_W).toFixed(0) : '';
                        if(document.getElementById('slider_w')) document.getElementById('slider_w').value = interactiveWField.value;
                    }

                    if (plot1Container && data.plot1_div_html) {
                        plot1Container.innerHTML = data.plot1_div_html;
                    } else if (plot1Container) {
                        plot1Container.innerHTML = "<p>{{_('Plot data not available.')}}</p>";
                    }
                    if (plot2Container && data.plot2_div_html) {
                        plot2Container.innerHTML = data.plot2_div_html;
                    } else if (plot2Container) {
                        plot2Container.innerHTML = ""; // Or some other placeholder
                    }
                }
            })
            .catch(error => {
                console.error('Error during interactive recalculation:', error);
                alert('An error occurred while recalculating. Please check the console.');
            });
        }, 750);
    }

    // Helper function to update a slider's max value if needed, and sync input
    function updateSliderMaxIfNeeded(inputElement, sliderElement) {
        const numericValue = parseFloat(inputElement.value);
        if (!isNaN(numericValue)) {
            // Adjust min if value goes below (though our inputs have min="0")
            if (numericValue < parseFloat(sliderElement.min)) {
                inputElement.value = sliderElement.min;
                sliderElement.value = sliderElement.min; // Sync slider to corrected input
                // No further max adjustment needed if value was clamped to min
                return;
            }
            // Adjust max if value goes above
            if (numericValue > parseFloat(sliderElement.max)) {
                sliderElement.max = Math.ceil(numericValue * 1.2 / (sliderElement.step || 1)) * (sliderElement.step || 1);
            }
            // Sync slider to current input value (which might have been clamped or is within new max)
            sliderElement.value = inputElement.value;
        }
    }

    // Debounced AJAX call logic
    function makeAjaxCall(changedParamType) { // changedParamType is 'W' or 'P'
        clearTimeout(debounceTimer);
        debounceTimer = setTimeout(() => {
            const wValue = parseFloat(interactiveWField.value) || 0;
            const pValue = parseFloat(interactivePField.value) || 0;

            const payload = {
                changed_input: changedParamType,
                W_value: wValue,
                P_value: pValue,
                r_overall_nominal: initialROverallNominal,
                i_overall: initialIOverall,
                total_duration_from_periods: initialTotalDuration,
                withdrawal_time_str: initialWithdrawalTimeStr,
                fixed_desired_final_value: initialDesiredFinalValue,
                rates_periods_summary: initialRatesPeriods,
                one_off_events_summary: initialOneOffEvents
            };

            fetch("{{ url_for('wizard_bp.wizard_recalculate_interactive') }}", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                },
                body: JSON.stringify(payload)
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert("Recalculation Error: " + data.error);
                    // Reset the field that was supposed to be calculated, to the value sent by server (original value)
                    if (changedParamType === 'W' && data.new_P !== undefined) {
                         interactivePField.value = parseFloat(data.new_P).toFixed(0);
                         updateSliderMaxIfNeeded(interactivePField, sliderP); // Update max just in case
                    } else if (changedParamType === 'P' && data.new_W !== undefined) {
                         interactiveWField.value = parseFloat(data.new_W).toFixed(0);
                         updateSliderMaxIfNeeded(interactiveWField, sliderW);
                    }
                } else {
                    // Update the OTHER input field and its slider's max if needed
                    if (changedParamType === 'W') { // W was sent, P is new
                        interactivePField.value = data.new_P !== undefined ? parseFloat(data.new_P).toFixed(0) : '';
                        updateSliderMaxIfNeeded(interactivePField, sliderP);
                    } else if (changedParamType === 'P') { // P was sent, W is new
                        interactiveWField.value = data.new_W !== undefined ? parseFloat(data.new_W).toFixed(0) : '';
                        updateSliderMaxIfNeeded(interactiveWField, sliderW);
                    }

                    // Update plots
                    if (plot1Container && data.plot1_div_html) {
                        plot1Container.innerHTML = data.plot1_div_html;
                    } else if (plot1Container) {
                        plot1Container.innerHTML = "<p>{{_('Plot data not available.')}}</p>";
                    }
                    if (plot2Container && data.plot2_div_html) {
                        plot2Container.innerHTML = data.plot2_div_html;
                    } else if (plot2Container) {
                        plot2Container.innerHTML = "";
                    }
                }
            })
            .catch(error => {
                console.error('Error during interactive recalculation:', error);
                alert('An error occurred while recalculating. Please check the console.');
            });
        }, 750);
    }

    const sliderW = document.getElementById('slider_w');
    const sliderP = document.getElementById('slider_p');

    interactiveWField.addEventListener('input', function() {
        updateSliderMaxIfNeeded(this, sliderW); // Update slider max based on input, and sync its value
        makeAjaxCall('W');
    });
    sliderW.addEventListener('input', function() {
        interactiveWField.value = this.value; // Sync input to this slider
        // No need to call updateSliderMaxIfNeeded from slider input, as slider is bound by its own max
        makeAjaxCall('W');
    });

    interactivePField.addEventListener('input', function() {
        updateSliderMaxIfNeeded(this, sliderP); // Update slider max based on input, and sync its value
        makeAjaxCall('P');
    });
    sliderP.addEventListener('input', function() {
        interactivePField.value = this.value; // Sync input to this slider
        makeAjaxCall('P');
    });

    // Initial console log for debugging data availability
    // console.log("Fixed params for JS:", {initialROverallNominal, initialIOverall, initialTotalDuration, initialWithdrawalTimeStr, initialDesiredFinalValue, initialRatesPeriods, initialOneOffEvents, csrfToken});
});
</script>
{% endblock %}
