{% extends "base.html" %}

{% block title %}{{ title }} - {{ super() }}{% endblock %}

{% block head_extra %}
    <meta name="csrf-token" content="{{ csrf_token_for_ajax }}"> {# For JS to fetch for AJAX headers #}
{% endblock %}

{% block content %}
  <h2>{{ title }}</h2>

  {# Display general error message if any from initial calculation #}
  {% if error_message %}
    <div class="alert alert-danger" role="alert">
      <h4>{{_("Initial Calculation Error")}}</h4>
      <p>{{ error_message }}</p>
    </div>
  {% endif %}

  {# --- Main Key Results & Consolidated Fixed Inputs --- #}
  <div class="card text-center mb-4">
    <div class="card-header">
      {{_("Calculation Summary")}}
    </div>
    <div class="card-body">
      {% if P_calculated_display and P_calculated_display != "Error" and P_calculated_display != "Not Feasible" %}
        <h3 class="card-title">{{_("Your Calculated FIRE Number:")}}</h3>
        <p id="display_p" class="display-4 fw-bold text-success">{{ P_calculated_display }}</p> {# Static Original P #}
        <hr>
        <h5 class="card-title mt-3">{{_("Based on:")}}</h5>
        <p id="display_w" class="card-text fs-5 mb-1"> {# Static Original W #}
          {{_("Input Annual Expenses (W):")}} <strong>{{ W_display }}</strong>
        </p>
      {% elif P_calculated_display %}
        <div class="alert alert-warning" role="alert">
            <h4 class="alert-heading">{{_("Calculation Outcome")}}</h4>
            <p class="fs-5">{{_("Calculated Required Initial Portfolio (FIRE Number):")}} <strong id="display_p">{{ P_calculated_display }}</strong></p>
            <hr>
            <p class="mb-0">{{_("Based on Input Annual Expenses (W):")}} <strong id="display_w">{{ W_display | default(W) }}</strong></p>
        </div>
      {% endif %}
      <div class="mt-3 text-muted small">
        <p class="mb-1">
          {{_("Overall Nominal Return:")}} {{ (r_overall_nominal * 100) | round(2) }}% |
          {{_("Inflation:")}} {{ (i_overall * 100) | round(2) }}% |
          {{_("Duration:")}} {{ total_duration_from_periods }} {{_("yrs")}}
        </p>
        <p class="mb-1">
          {{_("Withdrawal Timing:")}} {{ withdrawal_time_str | capitalize }} |
          {{_("Desired Final Portfolio:")}} {{ desired_final_value | default(0.0) }}
        </p>
        {% if rates_periods_summary and (rates_periods_summary | length > 1 or (rates_periods_summary | length == 1 and (rates_periods_summary[0].r != r_overall_nominal or rates_periods_summary[0].i != i_overall))) %}
          <p class="mb-1"><em>{{_("Custom rate periods applied for specific durations.")}}</em></p>
        {% endif %}
        {% if one_off_events_summary %}
          <p class="mb-0"><em>{{_("One-off financial events considered.")}}</em></p>
        {% else %}
          <p class="mb-0"><em>{{_("No one-off events specified.")}}</em></p>
        {% endif %}
      </div>
    </div>
  </div>

  {# --- Static Original Calculation Plots (Side-by-Side) --- #}
  <h3 class="mt-4 mb-3 text-center">{{_("Original Calculation Plots")}}</h3>
  {% if P_calculated_display and P_calculated_display != "Error" and P_calculated_display != "Not Feasible" %}
    <div class="row">
      <div id="original_plot1_container" class="col-md-6 mb-3" style="min-height: 400px; border: 1px solid #eee;"></div>
      <div id="original_plot2_container" class="col-md-6 mb-3" style="min-height: 400px; border: 1px solid #eee;"></div>
    </div>
  {% else %}
    <p class="text-center">{{_("Original plots not available due to calculation error or infeasible scenario.")}}</p>
  {% endif %}

  {# --- Interactive What-If Analysis (Card with Sliders and its own Plots) --- #}
  <div class="card text-center mb-4 mt-5">
    <div class="card-header">
      {{_("Interactive What-If Analysis")}}
    </div>
    <div class="card-body">
      <div id="interactive_debug_output" style="font-size:0.8em; text-align:left; max-height:150px; overflow-y:scroll; border:1px solid #ccc; background:#f0f0f0; padding:5px; margin-bottom:15px;"></div>
      {# Row for W input and slider #}
      <div class="row g-3 align-items-center justify-content-center mb-3">
        <div class="col-md-3 text-md-end">
          <label for="interactive_w" class="col-form-label">{{_("Adjust Annual Expenses (W):")}}</label>
        </div>
        <div class="col-md-3">
          <input type="number" id="interactive_w" class="form-control interactive-input" data-changed="W" value="{{ W | default(0.0) }}" step="1000" min="0">
        </div>
        <div class="col-md-6">
          <input type="range" id="slider_w" class="form-range interactive-slider" data-target="interactive_w" value="{{ W | default(0.0) }}" min="0" max="{{ (W * 2) | default(100000) | int }}" step="1000">
        </div>
      </div>

      {# Row for P input and slider #}
      <div class="row g-3 align-items-center justify-content-center mb-3">
        <div class="col-md-3 text-md-end">
          <label for="interactive_p" class="col-form-label">{{_("Adjust Target Portfolio (P):")}}</label>
        </div>
        <div class="col-md-3">
          <input type="number" id="interactive_p" class="form-control interactive-input" data-changed="P" value="{{ P_raw | default(0.0) }}" step="10000" min="0">
        </div>
        <div class="col-md-6">
          <input type="range" id="slider_p" class="form-range interactive-slider" data-target="interactive_p" value="{{ P_raw | default(0.0) }}" min="0" max="{{ (P_raw * 2) | default(2000000) | int }}" step="10000">
        </div>
      </div>
      <small class="form-text text-muted mt-2">{{_("Change one value or use slider to see how it impacts the other. Plots below will update.")}}</small>

      {# New Plot Containers for Interactive Analysis (Side-by-Side) #}
      <div class="row mt-4">
        <div id="interactive_plot1_container" class="col-md-6 mb-3" style="min-height: 400px; border: 1px solid #eee;"></div>
        <div id="interactive_plot2_container" class="col-md-6 mb-3" style="min-height: 400px; border: 1px solid #eee;"></div>
      </div>
    </div>
  </div>

  {# Hidden fields/script tags for fixed parameters #}
  <input type="hidden" id="initial_r_overall_nominal" value="{{ r_overall_nominal | default(0.0) }}">
  <input type="hidden" id="initial_i_overall" value="{{ i_overall | default(0.0) }}">
  <input type="hidden" id="initial_total_duration_from_periods" value="{{ total_duration_from_periods | default(30) }}">
  <input type="hidden" id="initial_withdrawal_time_str" value="{{ withdrawal_time_str | default('end') }}">
  <input type="hidden" id="initial_desired_final_value" value="{{ desired_final_value | default(0.0) }}">
  <script id="initial-rates-periods-data" type="application/json">{{ rates_periods_summary | default([]) | tojson | safe }}</script>
  <script id="initial-one-off-events-data" type="application/json">{{ one_off_events_summary | default([]) | tojson | safe }}</script>
  <script id="original-plot1-spec-data" type="application/json">{{ original_plot1_spec | default({}) | tojson | safe }}</script>
  <script id="original-plot2-spec-data" type="application/json">{{ original_plot2_spec | default({}) | tojson | safe }}</script>

  <div class="mt-4 text-center">
    <a href="{{ url_for('wizard_bp.wizard_expenses_step') }}" class="btn btn-secondary">{{ _("Start New Wizard") }}</a>
    <a href="{{ url_for('project.index') }}" class="btn btn-info">{{ _("Back to Home") }}</a>
  </div>

{% endblock %}

{% block scripts_extra %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const interactiveWField = document.getElementById('interactive_w');
    const interactivePField = document.getElementById('interactive_p');
    const sliderW = document.getElementById('slider_w');
    const sliderP = document.getElementById('slider_p');

    const interactivePlot1Container = document.getElementById('interactive_plot1_container');
    const interactivePlot2Container = document.getElementById('interactive_plot2_container');
    const debugOutputDiv = document.getElementById('interactive_debug_output');

    function logDebug(message) {
        if (debugOutputDiv) {
            const p = document.createElement('p');
            p.textContent = message;
            p.style.margin = '2px 0';
            debugOutputDiv.appendChild(p);
            debugOutputDiv.scrollTop = debugOutputDiv.scrollHeight;
        }
        console.log(message);
    }

    logDebug("DOMContentLoaded: Script started.");

    // Retrieve initial parameters
    const initialROverallNominal = parseFloat(document.getElementById('initial_r_overall_nominal').value);
    const initialIOverall = parseFloat(document.getElementById('initial_i_overall').value);
    const initialTotalDuration = parseInt(document.getElementById('initial_total_duration_from_periods').value);
    const initialWithdrawalTimeStr = document.getElementById('initial_withdrawal_time_str').value;
    const initialDesiredFinalValue = parseFloat(document.getElementById('initial_desired_final_value').value);

    let initialRatesPeriods = [];
    try {
        const initialRatesPeriodsElem = document.getElementById('initial-rates-periods-data');
        if (initialRatesPeriodsElem && initialRatesPeriodsElem.textContent) {
            initialRatesPeriods = JSON.parse(initialRatesPeriodsElem.textContent);
        }
    } catch (e) { logDebug("Error parsing initial rates periods: " + e); }

    let initialOneOffEvents = [];
    try {
        const initialOneOffEventsElem = document.getElementById('initial-one-off-events-data');
        if (initialOneOffEventsElem && initialOneOffEventsElem.textContent) {
            initialOneOffEvents = JSON.parse(initialOneOffEventsElem.textContent);
        }
    } catch (e) { logDebug("Error parsing initial one-off events: " + e); }

    const csrfTokenMeta = document.querySelector('meta[name="csrf-token"]');
    const csrfToken = csrfTokenMeta ? csrfTokenMeta.getAttribute('content') : null;
    logDebug("CSRF Token: " + (csrfToken ? "Loaded" : "Not Found!"));
    if (!csrfToken) { console.error('CSRF token not found!'); }

    logDebug("Initial W field value: " + (interactiveWField ? interactiveWField.value : "N/A"));
    logDebug("Initial P field value: "  + (interactivePField ? interactivePField.value : "N/A"));

    // Retrieve and render initial plot specs
    let originalPlot1Spec = null;
    let originalPlot2Spec = null;
    try {
        const plot1SpecEl = document.getElementById('original-plot1-spec-data');
        if (plot1SpecEl && plot1SpecEl.textContent) {
            originalPlot1Spec = JSON.parse(plot1SpecEl.textContent);
            logDebug("Original Plot 1 Spec loaded.");
        } else { logDebug("Original Plot 1 Spec data script tag not found or empty."); }

        const plot2SpecEl = document.getElementById('original-plot2-spec-data');
        if (plot2SpecEl && plot2SpecEl.textContent) {
            originalPlot2Spec = JSON.parse(plot2SpecEl.textContent);
            logDebug("Original Plot 2 Spec loaded.");
        } else { logDebug("Original Plot 2 Spec data script tag not found or empty."); }
    } catch (e) { logDebug("Error parsing initial plot spec JSON: " + e); }

    const originalPlot1Container = document.getElementById('original_plot1_container');
    const originalPlot2Container = document.getElementById('original_plot2_container');

    if (originalPlot1Spec && originalPlot1Spec.data && originalPlot1Spec.layout && originalPlot1Container) {
        Plotly.newPlot('original_plot1_container', originalPlot1Spec.data, originalPlot1Spec.layout, {responsive: true});
        logDebug("Original plot 1 rendered.");
    } else if (originalPlot1Container) {
        originalPlot1Container.innerHTML = "<p>{{_('Original balance plot data not available.')}}</p>";
        logDebug("Original plot 1 data/spec missing or container not found.");
    }

    if (originalPlot2Spec && originalPlot2Spec.data && originalPlot2Spec.layout && originalPlot2Container) {
        Plotly.newPlot('original_plot2_container', originalPlot2Spec.data, originalPlot2Spec.layout, {responsive: true});
        logDebug("Original plot 2 rendered.");
    } else if (originalPlot2Container) {
        originalPlot2Container.innerHTML = "<p>{{_('Original withdrawal plot data not available.')}}</p>";
        logDebug("Original plot 2 data/spec missing or container not found.");
    }

    // Helper function to update a slider's max value if needed, and sync input
    function updateSliderMaxIfNeeded(inputElement, sliderElement) {
        if (!inputElement || !sliderElement) {
            logDebug("updateSliderMaxIfNeeded: input or slider element missing.");
            return;
        }
        const numericValue = parseFloat(inputElement.value);
        if (!isNaN(numericValue)) {
            if (numericValue < parseFloat(sliderElement.min)) {
                logDebug(`Value ${numericValue} for ${inputElement.id} is less than slider min ${sliderElement.min}. Clamping.`);
                inputElement.value = sliderElement.min;
                sliderElement.value = sliderElement.min;
                return;
            }
            if (numericValue > parseFloat(sliderElement.max)) {
                const newMax = Math.ceil(numericValue * 1.2 / (parseInt(sliderElement.step) || 1)) * (parseInt(sliderElement.step) || 1);
                logDebug(`Value ${numericValue} for ${inputElement.id} is greater than slider max ${sliderElement.max}. New max: ${newMax}`);
                sliderElement.max = newMax;
            }
            sliderElement.value = inputElement.value;
        } else {
            logDebug(`updateSliderMaxIfNeeded: value for ${inputElement.id} is NaN.`);
        }
    }

    // Actual AJAX call logic
    function performAjaxCalculation(changedParamType) {
        logDebug(`performAjaxCalculation called. Changed: ${changedParamType}`);
        const wValue = parseFloat(interactiveWField.value) || 0;
        const pValue = parseFloat(interactivePField.value) || 0;
        logDebug(`W Value for AJAX: ${wValue}, P Value for AJAX: ${pValue}`);

        const payload = {
            changed_input: changedParamType, W_value: wValue, P_value: pValue,
            r_overall_nominal: initialROverallNominal, i_overall: initialIOverall,
            total_duration_from_periods: initialTotalDuration,
            withdrawal_time_str: initialWithdrawalTimeStr, fixed_desired_final_value: initialDesiredFinalValue,
            rates_periods_summary: initialRatesPeriods, one_off_events_summary: initialOneOffEvents
        };
        logDebug("AJAX Payload (first 300 chars): " + JSON.stringify(payload).substring(0, 300) + "...");

        const currentCsrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');

        fetch("{{ url_for('wizard_bp.wizard_recalculate_interactive') }}", {
            method: 'POST', headers: { 'Content-Type': 'application/json', 'X-CSRFToken': currentCsrfToken },
            body: JSON.stringify(payload)
        })
        .then(response => {
            logDebug("AJAX response received. Status: " + response.status);
            if (!response.ok) {
                logDebug("AJAX response not OK. Status text: " + response.statusText);
                return response.text().then(text => { throw new Error("Server error: " + response.status + " " + response.statusText + " Body: " + text.substring(0,200)); });
            }
            return response.json();
        })
        .then(data => {
            logDebug("AJAX response JSON parsed. Data (first 300 chars): " + JSON.stringify(data).substring(0, 300) + "...");
            if (data.error) {
                logDebug("AJAX data.error: " + data.error);
                if(interactivePlot1Container) interactivePlot1Container.innerHTML = `<p class='text-danger'>Error: ${data.error}</p>`;
                if(interactivePlot2Container) interactivePlot2Container.innerHTML = '';

                if (changedParamType === 'W' && interactivePField && data.new_P !== undefined) {
                    interactivePField.value = parseFloat(data.new_P).toFixed(0);
                    if(sliderP) updateSliderMaxIfNeeded(interactivePField, sliderP);
                } else if (changedParamType === 'P' && interactiveWField && data.new_W !== undefined) {
                    interactiveWField.value = parseFloat(data.new_W).toFixed(0);
                    if(sliderW) updateSliderMaxIfNeeded(interactiveWField, sliderW);
                }
            } else {
                logDebug("AJAX success. Updating fields and plots.");
                if (changedParamType === 'W') {
                    if(interactivePField) interactivePField.value = data.new_P !== undefined ? parseFloat(data.new_P).toFixed(0) : '';
                    if(sliderP && interactivePField) updateSliderMaxIfNeeded(interactivePField, sliderP);
                } else if (changedParamType === 'P') {
                    if(interactiveWField) interactiveWField.value = data.new_W !== undefined ? parseFloat(data.new_W).toFixed(0) : '';
                    if(sliderW && interactiveWField) updateSliderMaxIfNeeded(interactiveWField, sliderW);
                }

                // Update interactive plots using Plotly.react or Plotly.newPlot
                if (interactivePlot1Container && data.plot1_spec && data.plot1_spec.data && data.plot1_spec.layout) {
                    Plotly.react('interactive_plot1_container', data.plot1_spec.data, data.plot1_spec.layout, {responsive: true});
                    logDebug("Interactive plot 1 updated via Plotly.react().");
                } else if (interactivePlot1Container) {
                    interactivePlot1Container.innerHTML = "<p>{{_('Interactive balance plot data not available.')}}</p>";
                    logDebug("Interactive plot 1 spec missing in AJAX response or container error.");
                }

                if (interactivePlot2Container && data.plot2_spec && data.plot2_spec.data && data.plot2_spec.layout) {
                    Plotly.react('interactive_plot2_container', data.plot2_spec.data, data.plot2_spec.layout, {responsive: true});
                    logDebug("Interactive plot 2 updated via Plotly.react().");
                } else if (interactivePlot2Container) {
                    interactivePlot2Container.innerHTML = "<p>{{_('Interactive withdrawal plot data not available.')}}</p>";
                    logDebug("Interactive plot 2 spec missing in AJAX response or container error.");
                }
                logDebug("Interactive plots update attempt finished.");
            }
        })
        .catch(error => {
            logDebug("AJAX fetch failed or error in processing. Error: " + error);
            if(interactivePlot1Container) interactivePlot1Container.innerHTML = "<p class='text-danger'>Error loading plots via AJAX: " + error + "</p>";
            if(interactivePlot2Container) interactivePlot2Container.innerHTML = "";
        });
    }

    let debounceTimer;
    function makeAjaxCall(changedParamType) {
        clearTimeout(debounceTimer);
        logDebug(`makeAjaxCall (debounced) for: ${changedParamType}. Setting timeout.`);
        debounceTimer = setTimeout(() => {
            logDebug(`Debounced AJAX call executing for: ${changedParamType}`);
            performAjaxCalculation(changedParamType);
        }, 750);
    }

    if (interactiveWField && sliderW) {
        interactiveWField.addEventListener('input', function() { updateSliderMaxIfNeeded(this, sliderW); makeAjaxCall('W'); });
        sliderW.addEventListener('input', function() { if (interactiveWField) interactiveWField.value = this.value; makeAjaxCall('W'); });
    } else { logDebug("W input field or slider not found for event listener setup."); }

    if (interactivePField && sliderP) {
        interactivePField.addEventListener('input', function() { updateSliderMaxIfNeeded(this, sliderP); makeAjaxCall('P'); });
        sliderP.addEventListener('input', function() { if (interactivePField) interactivePField.value = this.value; makeAjaxCall('P'); });
    } else { logDebug("P input field or slider not found for event listener setup."); }

    const initialErrorMessage = {{ error_message | default('') | tojson | safe }};
    const initialPDisplay = {{ P_calculated_display | default('') | tojson | safe }};
    logDebug(`Initial page error_message: '${initialErrorMessage}'`);
    logDebug(`Initial P_calculated_display: '${initialPDisplay}'`);

    if (initialErrorMessage === '' && initialPDisplay !== 'Error' && initialPDisplay !== 'Not Feasible' && initialPDisplay !== '') {
        logDebug("Conditions met for initial AJAX call to populate interactive plots.");
        if (interactivePlot1Container) interactivePlot1Container.innerHTML = '<p>Loading initial interactive plots...</p>';
        performAjaxCalculation('W');
    } else {
        logDebug("Conditions NOT met for initial AJAX call. Interactive plots will not be pre-loaded.");
        if (interactivePlot1Container) {
            interactivePlot1Container.innerHTML = '<p>{{_("Interactive plots not loaded due to initial calculation error or infeasible scenario.")}}</p>';
        }
    }
});
</script>
{% endblock %}
