{% extends "base.html" %}
{% from "_formhelpers.html" import render_field, render_submit_field %}

{% block title %}{{ title }} - {{ super() }}{% endblock %}

{% block content %}
  <h2>{{ title }}</h2>
  <p>{{ _("Please enter your current annual expenses. This will help us understand your baseline financial needs.") }}</p>
  <form method="POST" action="{{ url_for('wizard_bp.wizard_expenses_step') }}" novalidate>
    {{ form.csrf_token }}
    <fieldset>
      <legend class="visually-hidden">{{ _("Expenses Form") }}</legend>
      {{ render_field(form.annual_expenses, class="form-control", placeholder=_("e.g., 50000")) }}
      {{ render_field(form.housing, class="form-control", placeholder=_("e.g., 15000")) }}
      {{ render_field(form.food, class="form-control", placeholder=_("e.g., 6000")) }}
      {{ render_field(form.transportation, class="form-control", placeholder=_("e.g., 5000")) }}
      {{ render_field(form.utilities, class="form-control", placeholder=_("e.g., 3000")) }}
      {{ render_field(form.personal_care, class="form-control", placeholder=_("e.g., 2000")) }}
      {{ render_field(form.entertainment, class="form-control", placeholder=_("e.g., 4000")) }}
      {{ render_field(form.healthcare, class="form-control", placeholder=_("e.g., 3000")) }}
      {{ render_field(form.other_expenses, class="form-control", placeholder=_("e.g., 1000")) }}
    </fieldset>
    {{ render_submit_field(form.submit, class="btn btn-primary mt-3") }}
  </form>
{% endblock %}

{% block scripts_extra %}
<script>
document.addEventListener('DOMContentLoaded', function () {
    const annualExpensesField = document.getElementById('annual_expenses');
    const itemizedFields = [
        document.getElementById('housing'),
        document.getElementById('food'),
        document.getElementById('transportation'),
        document.getElementById('utilities'),
        document.getElementById('personal_care'),
        document.getElementById('entertainment'),
        document.getElementById('healthcare'),
        document.getElementById('other_expenses')
    ];

    let userManuallyEditedTotal = false;

    // Check if annual_expenses initially has a value; if so, assume manual entry or prefill
    if (annualExpensesField.value.trim() !== '' && parseFloat(annualExpensesField.value) > 0) {
        userManuallyEditedTotal = true;
    }

    function calculateItemizedSum() {
        let sum = 0;
        itemizedFields.forEach(function(field) {
            if (field && field.value) {
                const val = parseFloat(field.value);
                if (!isNaN(val)) {
                    sum += val;
                }
            }
        });
        return sum;
    }

    function updateAnnualExpenses() {
        const sum = calculateItemizedSum();
        if (!userManuallyEditedTotal || annualExpensesField.value.trim() === '' || parseFloat(annualExpensesField.value) === 0) {
            // If user hasn't manually edited, or if they cleared it, or it's zero, then update.
            if (sum > 0) {
                annualExpensesField.value = sum.toFixed(2);
            } else if (!userManuallyEditedTotal) {
                // if sum is 0 and user hasn't touched total field, clear it
                annualExpensesField.value = '';
            }
        }
    }

    itemizedFields.forEach(function(field) {
        if (field) {
            field.addEventListener('input', function() {
                updateAnnualExpenses();
            });
        }
    });

    annualExpensesField.addEventListener('input', function() {
        const manualValue = annualExpensesField.value.trim();
        if (manualValue !== '' && parseFloat(manualValue) > 0) {
            userManuallyEditedTotal = true;
        } else {
            // If user clears the total field or sets it to 0, allow itemized sum to repopulate it.
            userManuallyEditedTotal = false;
            updateAnnualExpenses(); // Recalculate and potentially fill if itemized sum > 0
        }
    });

    // Initial calculation on page load, in case of pre-filled itemized fields (e.g., from session)
    updateAnnualExpenses();
});
</script>
{% endblock %}
